<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=b3cjGm4GiaI1GzcYKjil0fyrP7qHL9eL"></script>

    <link rel="import" href="/html/include/vb.html">
    <link rel="import" href="/html/include/fc.html">
    <link rel="import" href="/html/include/vc.html">
    <link rel="import" href="/html/include/db.html">

    <title>终端管理界面</title>
    <style>
        #terminalDisplay {
            padding: 10px;
        }

        .termialDis {
            padding: 0px;
            width: 260px;
            margin: 5px;
            text-align: center;
            float: left;
        }

        .termialDis>div>.screenshoot {
            height: 150px;
            background: url(/assets/img/no-program.png) center center no-repeat #fff;
        }

        .offline>div>.screenshoot {
            height: 150px;
            background: url(/assets/img/offline.png) center center no-repeat #fff;
        }

        .termialDis>div>div>.image {
            display: block;
            max-height: 150px;
            width: 100%;
            text-align: center;
            margin: 0px;
            padding: 0px;
        }

        .termialDis>div>div>.ratio {
            position: relative;
            top: -19px;
            background-color: #ddd;
            background: linear-gradient(white, #ccc);
        }

        .termialDis>div>.control {
            padding: 10px;
            text-align: left;
        }

        .termialDis>div>.deviceInfo {
            text-align: left;
            padding: 10px;
        }

        .termialDis>div>.deviceInfo>.name {
            font-weight: bolder;
        }

        .termialDis>div>.deviceInfo>.size {
            float: right;
        }

        .termialDis>div>.control>.bottom {
            margin-top: 10px;
            text-align: center;
        }

        .offline {
            background-color: #c0c4cc;
        }

        .t-title {
            cursor: auto !important;
            opacity: 1 !important;
        }

        .online-icon {
            background: green;
            color: green !important;
        }

        .offline-icon {
            background: #ddd;
            color: #ddd !important;
        }

        .pagebar {
            margin-top: 15px;
        }

        .command-list {
            overflow: auto;
            margin-bottom: 100px;
        }

        .command-list>.action {
            display: inline-block;
            position: relative;
            margin: 6px 6px 3px;
            width: 90px;
            height: 90px;
            border-radius: 5px;
            color: #999;
            text-align: center;
            cursor: pointer;
            float: left;
            border: solid 1px #ddd;
            text-decoration: none;
            background-color: #eee;
        }

        .command-list>.action>i {
            font-size: 55px;
            color: orange;
            margin-top: 5px;
        }

        .command-list>.active {
            background-color: #337ab7;
            color: white;
        }

        .command-list>.active>i {
            color: white;
        }

        .screenshoot-h {
            width: 250px;
        }

        .screenshoot-h>.image {
            width: 100%;
        }
        .disInfo{
            width: 100%;
        }
        .disInfo>tbody>tr>td {
            padding: 3px 5px;
        }

        .bottom-h>button {
            margin-top: 10px;
        }

        .el-dialog__body {
            overflow: auto;
            padding: 0 15px 15px 15px;
        }
        .el-menu-item i{
            color:auto;
        }
        .el-button--primary>i{
            color:white;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="toolbar">
            <el-row>
                <el-col :span="24">
                    <el-menu :default-active="tqueryIf.online=='1'?'1':'2'" class="el-menu-demo" mode="horizontal">
                        <el-menu-item index="-1" class="t-title" disabled>终端情况: </el-menu-item>
                        <el-menu-item index="1" @click="changeSearch(1)">
                            <i class="el-icon-check online-icon"></i>正常 ({{onlineCount.online?onlineCount.online:0}})</el-menu-item>
                        <el-menu-item index="2" @click="changeSearch(0)">
                            <i class="el-icon-close offline-icon"></i> 终端不在线 ({{onlineCount.offline?onlineCount.offline:0}})</el-menu-item>
                        <el-menu-item index="-3" class="t-title" disabled>
                            <el-button-group class="control-button">
                                <el-button size="small" :type="!dis_h_v?'primary':''" icon="el-icon-menu" @click="dis_h_v=false"></el-button>
                                <el-button size="small" :type="dis_h_v?'primary':''" icon="el-icon-tickets" @click="dis_h_v=true"></el-button>
                            </el-button-group>
                        </el-menu-item>
                        <el-menu-item index="-2" :style="{'float':'right'}" class="t-title" disabled>
                            <el-pagination class="pagebar" :current-page="tpager.current" :page-sizes="[10, 20, 30]" :page-size="tpager.size" layout="total, sizes, prev, pager, next, jumper"
                                :total="tpager.total" @size-change="handleSizeChange" @current-change="handleCurrentChange">
                            </el-pagination>
                        </el-menu-item>
                    </el-menu>
                </el-col>
            </el-row>
        </div>
        <div id="terminalDisplay">
            <div v-if="dis_h_v">
                <table class="table   table-hover">
                    <thead>
                        <th>屏幕截图</th>
                        <th>硬件信息</th>
                        <th>软件信息</th>
                        <th>地理位置信息</th>
                        <th>控制</th>
                    </thead>
                    <tbody>
                        <template v-for="t in terminals">
                            <tr :class="t.online=='1' ? 'online':'offline'">
                                <td>
                                    <div class="screenshoot-h">
                                        <img src="/assets/img/program-test.jpg" class="image">
                                    </div>
                                </td>
                                <td>
                                    <table class="disInfo">
                                        <tr>
                                            <td>设备名 </td>
                                            <td>：{{t.name}}</td>
                                        </tr>
                                        <tr>
                                            <td>屏幕尺寸 </td>
                                            <td>：{{t.size}}</td>
                                        </tr>
                                        <tr>
                                            <td>分辨率 </td>
                                            <td>：{{t.ratio}}</td>
                                        </tr>
                                        <tr>
                                            <td>屏幕类型</td>
                                            <td>：{{t.rev}}</td>
                                        </tr>
                                        <tr>
                                            <td>触摸屏 </td>
                                            <td>：{{t.typ}}</td>
                                        </tr>
                                        <tr>
                                            <td>是否在线 </td>
                                            <td>：<el-tag size="small" :type="t.online == '1'?'success':'danger'">{{t.online == '1' ? '是':'否'}}</el-tag></td>
                                        </tr>
                                        <tr>
                                            <td>最后心跳时间</td>
                                            <td>：{{getDateTimeInfo(t.last_time)}}</td>
                                        </tr>

                                    </table>
                                </td>
                                <td>
                                    <table class="disInfo">
                                        <tr>
                                            <td>当前节目</td>
                                            <td>：暂无节目</td>
                                        </tr>
                                        <tr>
                                            <td>操作系统</td>
                                            <td>：{{t.sys}}</td>
                                        </tr>
                                        <tr>
                                            <td>IP</td>
                                            <td>：{{t.ip}}</td>
                                        </tr>
                                        <tr>
                                            <td>MAC</td>
                                            <td>：{{t.mac}}</td>
                                        </tr>
                                        <tr>
                                            <td>版本</td>
                                            <td>：{{t.ver}}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <table class="disInfo">
                                        <tr>
                                            <td>位置</td>
                                            <td>：{{t.addr}}</td>
                                        </tr>
                                        <tr>
                                            <td>Gis</td>
                                            <td>：{{t.gis}}</td>
                                        </tr>
                                        <tr>
                                            <td>保修状态</td>
                                            <td>：
                                                <el-tag type="success" size="small">{{t.warranty}} 未过保</el-tag>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>loc</td>
                                            <td>：{{t.loc}}</td>
                                        </tr>
                                        <tr>
                                            <td>联系电话</td>
                                            <td>：{{t.tel}}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <div class="bottom-h">
                                        <el-button type="button" size="mini" class="button" @click="openTerminalController(t)">控制</el-button>
                                        <br/>
                                        <el-button type="button" size="mini" class="button" @click="openTerminalProgram(t)">节目</el-button>
                                        <br/>
                                        <el-button type="button" size="mini" class="button" @click="openTerminalLog(t)">日志</el-button>
                                        <br/>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div v-if="!dis_h_v">
                <template v-for="t in terminals">
                    <el-card class="termialDis" :class="t.online=='1' ? 'online':'offline'" :body-style="{ padding: '0px' }">
                        <div class="deviceInfo">
                            <span class="name">{{t.name}}</span>
                            <span class="size">{{t.size}}</span>
                        </div>
                        <div class="screenshoot">
                            <img src="/assets/img/program-test.jpg" class="image">
                            <div class="ratio">{{t.ratio}}</div>
                        </div>
                        <div class="control" style="">
                            <table class="disInfo">
                                <tr>
                                    <td>当前节目</td>
                                    <td>：暂无节目</td>
                                </tr>
                                <tr>
                                    <td>IP</td>
                                    <td>：{{t.ip}}</td>
                                </tr>
                                <tr>
                                    <td>版本</td>
                                    <td>：{{t.ver}}</td>
                                </tr>
                            </table>
                            <div class="bottom clearfix">
                                <el-button type="button" size="mini" class="button" @click="openTerminalController(t)">控制</el-button>
                                <el-button type="button" size="mini" class="button" @click="openTerminalProgram(t)">节目</el-button>
                                <el-button type="button" size="mini" class="button" @click="openTerminalLog(t)">日志</el-button>
                            </div>
                        </div>
                    </el-card>
                </template>
            </div>
        </div>
        <!--dialog-->
        <el-dialog :title="tcw.title" :visible.sync="tcw.visiable" :fullscreen="tcw.fullscreen" :width="tcw.fullscreen?'100%':'70%'">
            <div slot="title">
                <span class="el-dialog__title"> {{tcw.title}}</span>
                <el-button-group style="margin-left:30px;">
                    <el-button size="small" icon="el-icon-rank" @click="tcw.fullscreen=!tcw.fullscreen" title="最大"></el-button>
                </el-button-group>
            </div>
            <div class="command-list">
                <template v-for="control in controlList">
                    <a class="action" :class="control.checked ? 'active':''" id="start" @click="SendCommand(control)">
                        <i :class="control.icon" aria-hidden="true"></i>
                        <div class="start">{{control.label}}</div>
                    </a>
                </template>
            </div>
        </el-dialog>
        <el-dialog :title="tlw.title" :visible.sync="tlw.visiable" :fullscreen="tlw.fullscreen" :width="tlw.fullscreen?'100%':'70%'">
            <div slot="title">
                <span class="el-dialog__title"> {{tlw.title}}</span>
                <el-button-group style="margin-left:30px;">
                    <el-button size="small" icon="el-icon-rank" @click="tlw.fullscreen=!tlw.fullscreen" title="最大"></el-button>
                </el-button-group>
            </div>
            <el-menu default-active="1" class="el-menu-demo" mode="horizontal">
                <el-menu-item index="1"> 操作日志 </el-menu-item>
                <el-menu-item index="2"> 终端执行日志 </el-menu-item>
                <el-menu-item index="3"> 系统日志 </el-menu-item>
                <el-menu-item index="3"> 心跳日志 </el-menu-item>
                <el-menu-item index="5"> 播放器日志 </el-menu-item>
            </el-menu>
            <el-container>
                <el-main>
                    <template>
                        <el-table :data="logs" style="width: 100%">
                            <el-table-column type="expand">
                                <template slot-scope="props">
                                    <pre class="brush: js">{{ props.row.params }}</pre>
                                </template>
                            </el-table-column>
                            <el-table-column label="id" prop="logId" width="100">
                            </el-table-column>
                            <el-table-column label="时间" width="180">
                                <template slot-scope="scope">
                                    <div slot="reference" class="name-wrapper">
                                        {{ scope.row.date | datetime }}
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作用户" prop="username" width="155">
                            </el-table-column>
                            <el-table-column label="ip" prop="ip" width="155">
                            </el-table-column>
                            <el-table-column label="等级" width="100">
                                <template slot-scope="scope">
                                    <div slot="reference" class="name-wrapper">
                                        <el-tag :type="level_dis(scope.row)" size="medium">{{ scope.row.level }}</el-tag>
                                    </div>
                                </template>
                            </el-table-column>
                            <el-table-column label="操作信息描述" prop="operation">
                            </el-table-column>
                        </el-table>
                    </template>
                </el-main>
            </el-container>
        </el-dialog>
        <el-dialog :title="pgw.title" :visible.sync="pgw.visiable" :fullscreen="pgw.fullscreen" :width="pgw.fullscreen?'100%':'70%'">
            <div slot="title">
                <span class="el-dialog__title"> {{pgw.title}}</span>
                <el-button-group style="margin-left:30px;">
                    <el-button size="small" icon="el-icon-menu" @click="prg_dis_h_v=false" :type="!prg_dis_h_v?'primary':''"></el-button>
                    <el-button size="small" icon="el-icon-tickets" @click="prg_dis_h_v=true" :type="prg_dis_h_v?'primary':''"></el-button>
                    <el-button size="small" icon="el-icon-rank" @click="pgw.fullscreen=!pgw.fullscreen" title="最大"></el-button>
                </el-button-group>
            </div>

            <div v-if="prg_dis_h_v">
                <table class="table table-board">
                    <thead>
                        <th>节目封面</th>
                        <th>节目信息</th>
                        <th>播放模式</th>
                        <th>控制</th>
                    </thead>
                    <tbody>
                        <template v-for="t in tprograms">
                            <tr >
                                <td>
                                    <div class="screenshoot-h">
                                        <img src="/assets/img/program-test.jpg" class="image">
                                    </div>
                                </td>
                                <td>
                                    <table class="disInfo">
                                        <tr>
                                            <td>节目名称 </td>
                                            <td>：{{t.Name}}</td>
                                        </tr>
                                        <tr>
                                            <td>发布类型 </td>
                                            <td>：<span v-html="t.PublishTypeStr"></span></td>
                                        </tr>
                                        <tr>
                                            <td>发布人 </td>
                                            <td>：{{t.UserName}}</td>
                                        </tr>
                                        <tr>
                                            <td>发布时间</td>
                                            <td>：{{t.CreateTime}}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <table class="disInfo">
                                        <tr>
                                            <td>播放时间 ：</td>
                                            <td><span v-html="t.PlayTime"></span></td>
                                        </tr>
                                        <tr>
                                            <td>有效日期 ：</td>
                                            <td>{{t.ActiveTime}}</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>
                                    <div class="bottom-h">
                                        <el-button type="button" size="mini" class="button" @click="openTerminalController(t)">插播</el-button>
                                        <br/>
                                        <el-button type="button" size="mini" class="button" @click="openTerminalProgram(t)">暂停</el-button>
                                        <br/>
                                        <el-button type="danger" size="mini" class="button" @click="openTerminalLog(t)">删除</el-button>
                                        <br/>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            <div v-if="!prg_dis_h_v">
                <template v-for="t in tprograms">
                    <el-card class="termialDis" :body-style="{ padding: '0px' }">
                        <div class="deviceInfo">
                            <span class="name">{{t.Name}}</span>
                        </div>
                        <div class="screenshoot">
                            <img :src="getImgUrl(t.CoverImage)" class="image">
                            <div class="ratio">{{t.ratio}}</div>
                        </div>
                        <div class="control" style="">
                            <table class="disInfo">
                                <tr>
                                    <td>发布类型 </td>
                                    <td>：<span v-html="t.PublishTypeStr"></span></td>
                                </tr>
                                <tr>
                                    <td>发布人 </td>
                                    <td>：{{t.UserName}}</td>
                                </tr>
                                <tr>
                                    <td>发布时间</td>
                                    <td>：{{t.CreateTime}}</td>
                                </tr>
                            </table>
                            <div class="bottom clearfix">
                                <el-button type="button" size="mini" class="button" @click="openTerminalController(t)">插播</el-button>
                                <el-button type="button" size="mini" class="button" @click="openTerminalProgram(t)">暂停</el-button>
                                <el-button type="danger" size="mini" class="button" @click="openTerminalLog(t)">删除</el-button>
                            </div>
                        </div>
                    </el-card>
                </template>
            </div>
        </el-dialog>
        <!--dialog-->
    </div>
</body>

<script>
    window.appInstince = new Vue({
        el: '#app',
        data: {
            prg_dis_h_v: false,
            dis_h_v: false,
            terminals: [],//终端数据
            tprograms:[],//终端节目数据
            logs: [],
            tpager:{
                total:0,
                current:1,
                size:10
            },
            onlineCount:{

            },
            tqueryIf:{
                online:'1'
            },
            pgw: {
                title: '',
                visiable: false,
                terminal: null,
                fullscreen: false
            },
            tcw: {
                title: '终端控制指令下发',
                visiable: false,
                terminal: null,
                fullscreen: false
            },
            tlw: {
                title: '日志信息',
                visiable: false,
                terminal: null,
                fullscreen: false
            },
            controlList: [{
                type: 'play',
                label: '开始播放',
                opt: '1',
                icon: 'fa fa-play-circle',
                checked: false
            }, {
                type: 'play',
                label: '停止播放',
                opt: '0',
                icon: 'fa fa-stop-circle-o',
                checked: false
            }, {
                type: 'volume',
                label: '音量+',
                opt: '1',
                icon: 'fa fa-volume-up',
                checked: false
            }, {
                type: 'volume',
                label: '音量-',
                opt: '0',
                icon: 'fa fa-volume-down',
                checked: false
            }, {
                type: 'volume',
                label: '静音',
                opt: '2',
                icon: 'fa fa-volume-off',
                checked: false
            }, {
                type: 'volume',
                label: '取消静音',
                opt: '3',
                icon: 'fa fa-volume-up',
                checked: false
            }, {
                type: 'screenshot',
                label: '截屏',
                opt: '600|600',
                icon: 'fa fa-scissors',
                checked: false
            }, {
                type: 'ocscreen',
                label: '打开播放器',
                opt: '1',
                icon: 'fa fa-power-off',
                checked: false
            }, {
                type: 'ocscreen',
                label: '关闭播放器',
                opt: '0',
                icon: 'fa fa-times-circle',
                checked: false
            }, {
                type: 'wakelock',
                label: '打开显示屏',
                opt: '1',
                icon: 'fa fa-television',
                checked: false
            }, {
                type: 'wakelock',
                label: '关闭显示屏',
                opt: '0',
                icon: 'fa fa-window-close',
                checked: false
            }, {
                type: 'cleardata',
                label: '清空数据',
                opt: '1',
                icon: 'fa fa-trash-o',
                checked: false
            }, {
                type: 'refresh',
                label: '刷新页面',
                opt: '1',
                icon: 'fa fa-refresh',
                checked: false
            }, {
                type: 'version',
                label: '显示版本',
                opt: '1',
                icon: 'fa fa-info-circle',
                checked: false
            }, {
                type: 'version',
                label: '关闭版本显示',
                opt: '0',
                icon: 'fa fa-times',
                checked: false
            }, {
                type: 'upgrade',
                label: '升级',
                opt: '0',
                icon: 'fa fa-cloud-upload',
                checked: false
            }, {
                type: 'shutdown',
                label: '关机',
                opt: '1',
                icon: 'fa fa-toggle-off',
                checked: false
            }, {
                type: 'reboot',
                label: '重启',
                opt: '1',
                icon: 'fa fa-repeat',
                checked: false
            }]

        },
        mounted() {
            this.loadTeminalInfo();
            this.loadTerminalLogs();
        },
        methods: {
            loadTeminalInfo() {
                let me = this;
                let url = '/terminal/basic/queryInfo/'+this.tpager.current+'-'+this.tpager.size;
                ajax_json_promise(url, 'post',this.tqueryIf).then((result) => {
                    if(result.data){
                        me.tpager.total = result.data.total;
                        me.terminals = result.data.list;
                    }else{
                        me.tpager.total = 0;
                        me.terminals = [];
                    }
                    me.onlineCount = result.online;
                });
            },
            loadTerminalLogs() {
                let me = this;
                ajax_promise('/terminal/logs', 'post').then(result => {
                    me.logs = result.data;
                })
            },
            openTerminalController(tm_info) {
                this.controlList.map((c) => {
                    c.checked = false;
                });
                this.tcw.terminal = tm_info;
                this.tcw.visiable = true;
                this.tcw.title = tm_info.name + ' 控制指令';
            },
            openTerminalProgram(tm_info) {
                let me = this;
                this.pgw.visiable = true;
                this.pgw.title = tm_info.name + ' 节目列表';
                this.tlw.terminal = tm_info;
                let url = '/terminal/control/'+tm_info.id+'/program';
                ajax_promise(url,'get').then(result=>{
                    me.tprograms = result.data;
                });
            },
            openTerminalLog(tm_info) {
                this.tlw.terminal = tm_info;
                this.tlw.visiable = true;
                this.tlw.title = tm_info.name + ' 日志信息';
            },
            SendCommand(control) {
                this.controlList.map((c) => {
                    c.checked = false;
                });
                control.checked = true;
                let tid = this.tcw.terminal.id
                let cmd = {commandName:control.label,command:control.type,commandContent:control.opt,screenId:tid};
                let url = '/terminal/control/'+tid+'/command';
                ajax_json_promise(url,'post',cmd).then(result =>{
                    if(result.status){
                        this.$message({
                            message: '已送指令: ' + control.label,
                            type: 'success'
                        });
                    }
                });
            },
            level_dis(target) {
                if (target.level == 'DEBUG') return '';
                if (target.level == 'INFO') return 'info';
                if (target.level == 'WARN') return 'warning';
                if (target.level == 'ERROR') return 'danger';
                if (target.level == 'FATAL') return 'danger';
                return '';
            },//计算 时间信息
            getDateTimeInfo(dt) {
                if(!dt)return '未知';
                return timeAgo(new Date(dt));
            }, 
            handleSizeChange(val) {
              //console.log(`每页 ${val} 条`);
              this.tpager.size = val;
              this.loadTeminalInfo();
          },
          handleCurrentChange(val) {
              //console.log(`当前页: ${val}`);
              this.tpager.current = val;
              this.loadTeminalInfo();
          },
          changeSearch(type){
              this.tqueryIf.online=type;
              this.loadTeminalInfo();
          },
          getImgUrl(str){
            let pt = /img\W+src=[\"]+([\/\-\.\w]+)+/
            var group = str.match(pt); 
            return group[1];
          }
        }
    });
</script>

</html>